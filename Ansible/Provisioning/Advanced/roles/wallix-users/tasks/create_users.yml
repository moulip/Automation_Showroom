---
# Create users on WALLIX

- name: Create users
  uri:
    url: "{{ wallix_api.base_url }}/users"
    method: POST
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      user_name: "{{ item.name }}"
      display_name: "{{ item.display_name | default(item.name) }}"
      email: "{{ item.email | default('') }}"
      groups: "{{ item.groups | default([]) }}"
      profile: "{{ item.profile | default('user') }}"
      is_disabled: "{{ item.disabled | default(false) }}"
      force_change_pwd: "{{ item.force_change_password | default(false) }}"
      user_auths: "{{ item.user_auths | default(['local_password']) }}"
      password: "{{ item.credentials.local_password | default(item.password | default('')) }}"
      ssh_public_key: "{{ item.credentials.local_sshkey | default(item.credentials.ssh_public_key | default('')) }}"
      certificate_dn: "{{ item.credentials.local_x509 | default(item.credentials.certificate_dn | default('')) }}"
      gpg_public_key: "{{ item.credentials.gpg_public_key | default('') }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 201, 204, 409]
    return_content: yes
  register: user_creation_result
  loop: "{{ wallix_users }}"
  when: 
    - item.state | default('present') == 'present'
    - (wallix_users_mode | default('normal')) != 'dry_run'

  no_log: false  # Temporarily disabled to see errors

- name: Debug user creation results
  debug:
    msg:
      - "User: {{ item.item.name }}"
      - "Display Name: {{ item.item.display_name | default(item.item.name) }}"
      - "Profile: {{ item.item.profile | default('user') }}"
      - "Status: {{ item.status }}"
  loop: "{{ user_creation_result.results }}"
  when: 
    - user_creation_result.results is defined
    - wallix_users_debug.enabled | default(false)

- name: Set user creation status
  set_fact:
    wallix_users_status: "success"
    wallix_users_created: "{{ (user_creation_result.results | selectattr('status', 'equalto', 201) | list | length) + (user_creation_result.results | selectattr('status', 'equalto', 204) | list | length) }}"
    wallix_users_existing: "{{ user_creation_result.results | selectattr('status', 'equalto', 409) | list | length }}"
  when: user_creation_result.results is defined

- name: Display users creation summary
  debug:
    msg:
      - "âœ… Users management completed"
      - "Users created: {{ wallix_users_created | default(0) }}"
      - "Users already existing: {{ wallix_users_existing | default(0) }}"