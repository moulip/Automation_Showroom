---
# WALLIX Devices - Handlers

- name: "Refresh device inventory"
  uri:
    url: "{{ wallix_api_base_url }}/api/devices/refresh"
    method: POST
    headers:
      Cookie: "{{ wallix_api_session_cookie | default('') }}"
      Authorization: "Bearer {{ wallix_api_token | default('') }}"
      Content-Type: "application/json"
    body: '{}'
    body_format: json
    validate_certs: "{{ wallix_auth.connection.verify_ssl | default(true) }}"
    timeout: "{{ wallix_auth.connection.timeout | default(30) }}"
    status_code: [200, 202]
  listen: "Refresh device inventory"

- name: "Update device monitoring"
  uri:
    url: "{{ wallix_api_base_url }}/api/devices/monitoring/update"
    method: POST
    headers:
      Cookie: "{{ wallix_api_session_cookie | default('') }}"
      Authorization: "Bearer {{ wallix_api_token | default('') }}"
      Content-Type: "application/json"
    body: '{"refresh_all": true}'
    body_format: json
    validate_certs: "{{ wallix_auth.connection.verify_ssl | default(true) }}"
    timeout: "{{ wallix_auth.connection.timeout | default(30) }}"
    status_code: [200, 202]
  listen: "Update device monitoring"

- name: "Generate device report"
  template:
    src: "device_report.json.j2"
    dest: "/tmp/wallix_devices_report_{{ inventory_hostname }}_{{ ansible_date_time.epoch }}.json"
    mode: '0644'
  delegate_to: localhost
  listen: "Generate device report"

- name: "Notify device changes"
  debug:
    msg:
      - "Device configuration has been updated on {{ inventory_hostname }}"
      - "Total devices: {{ wallix_devices_total | default(0) }}"
      - "Applied at: {{ ansible_date_time.iso8601 }}"
  listen: "Generate device report"

- name: "Test device connections"
  uri:
    url: "{{ wallix_api_base_url }}/api/devices/test-connections"
    method: POST
    headers:
      Cookie: "{{ wallix_api_session_cookie | default('') }}"
      Authorization: "Bearer {{ wallix_api_token | default('') }}"
      Content-Type: "application/json"
    body: '{"test_all": true}'
    body_format: json
    validate_certs: "{{ wallix_auth.connection.verify_ssl | default(true) }}"
    timeout: 120
    status_code: [200, 202]
  listen: "Test device connections"